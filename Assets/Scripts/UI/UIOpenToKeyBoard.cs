using System.Collections;
using UnityEngine;

public class UIOpenToKeyBoard : MonoBehaviour
{
    [SerializeField] private GameObject pressedKeyImage;    // ???? ????? ???????
    [SerializeField] private AnimationCurve speedCurve;     // ?��??? ???? ????? ????? ????? ??????? AnimationCurve
    [SerializeField] private Vector3 originalPosition;      // ??????? ???? ???
    [SerializeField] private GameObject openUI;             // UI ? ???

    private ChatNPC chatNPC;        // NPC?? ?????? ???? ???????

    private bool isRising = false;  // ???? ?????? ????
    private bool isFalling = false; // ???????? ?????? ????
    private bool isEnter = false;   // ?��???? ??????? ????
    private float targetHeight;     // ???? ??? ????
    private float startTime;        // ???? ???? ?��?
    private float reverseTime;      // ??? ???? ?��?

    public void Start()
    {
        Debug.Assert(pressedKeyImage != null, "?????? ??? ? UI?? ???????.");
        originalPosition = pressedKeyImage.transform.position;              // ???? ??? ????
        pressedKeyImage.SetActive(false);                                   // ???? ?? ????? ??????

        chatNPC = GetComponent<ChatNPC>();
    }

    public void Update()
    {
        // ???? ?????
        if (isRising)
        {
            pressedKeyImage.SetActive(true);

            if (reverseTime < 0)
                reverseTime = 0.0f;

            // ??????? ????? ?��??? ???? ??? ?? ???
            float timeSinceStart = Time.time - startTime + reverseTime;
            float newHeight = originalPosition.y + speedCurve.Evaluate(timeSinceStart);

            // ??????? ???? ?��?
            pressedKeyImage.transform.position = new Vector3(pressedKeyImage.transform.position.x, newHeight, pressedKeyImage.transform.position.z);

            // ??? ????? ??????? ???? ???? ????
            if (pressedKeyImage.transform.position.y >= targetHeight)
                isRising = false;
        }

        // ???????? ?????
        if (isFalling)
        {
            // ??????? ????? ?��??? ???? ??? ?? ???
            float timeSinceStart = reverseTime + startTime - Time.time;
            float newHeight = originalPosition.y + speedCurve.Evaluate(timeSinceStart);

            // ??????? ???? ????
            pressedKeyImage.transform.position = new Vector3(pressedKeyImage.transform.position.x, newHeight, pressedKeyImage.transform.position.z);

            // ???? ????? ??????? ???????? ???? ????
            if (pressedKeyImage.transform.position.y <= targetHeight)
            {
                isFalling = false;
                pressedKeyImage.SetActive(false);
                pressedKeyImage.transform.position = originalPosition; // ???? ????? ???
            }
        }

        if (isEnter && !openUI.activeSelf && Input.GetKeyDown(KeyCode.F))
        {
            if (chatNPC != null && !chatNPC.dialog.isChat)
            {
                chatNPC.Chat("BlackSmith");
                StartCoroutine(WaitChat());
            }

            else
                openUI.SetActive(true);
        }
    }

    private IEnumerator WaitChat()
    {
        while (chatNPC.dialog.isChat)
            yield return null;

        openUI.SetActive(true);
        openUI.SetActive(true);
    }

    public void OnTriggerEnter2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            // ?��?? ????????? ?��?????? ??? ??????? ??????? ???? ????
            pressedKeyImage.SetActive(true);

            isRising = true;
            isFalling = false;  // ???????? ?????? ???? ???? ?????? ????
            isEnter = true;     // ?��???? ???????? ???

            targetHeight = pressedKeyImage.transform.position.y + speedCurve.keys[speedCurve.length - 1].value;   // ??? ???? ????
            reverseTime = reverseTime + startTime - Time.time;          // ???? ???? ?��? ????
            startTime = Time.time;                        // ???? ???? ?��? ????
        }
    }

    public void OnTriggerExit2D(Collider2D other)
    {
        if (other.CompareTag("Player"))
        {
            // ?��???? ????? ?????? ?????????? ???? ???????? ???? ????
            isRising = false;
            isFalling = true;
            isEnter = false;

            targetHeight = originalPosition.y;      // ??? ????? ???? ????? ????
            reverseTime = Time.time - startTime;    // ???? ???? ?��? ????
            startTime = Time.time;
        }
    }
}